<!DOCTYPE html>
<html>
<head>
  <title>GT3D BLE Sniffer</title>
</head>
<body>
  <h2>GT3D BLE Sniffer (mit Raw Dump)</h2>
  <button onclick="connect()">ğŸ”— Verbinden & Lauschen</button><br><br>
  <label for="hexInput">ğŸ“¤ HEX senden:</label>
  <input id="hexInput" type="text" placeholder="z.â€¯B. 5A A5 03 20 01" style="width:300px">
  <button onclick="sendHex()">â¡ï¸ Senden</button>
  <pre id="log" style="background:#eee;padding:10px;height:300px;overflow:auto;margin-top:20px;"></pre>
  <a id="download" style="display:block;margin-top:10px;" download="dump.txt">â¬‡ï¸ Dump herunterladen</a>

  <script>
    let writeChar = null;
    let dump = [];

    function log(msg) {
      const el = document.getElementById("log");
      const line = `[${new Date().toISOString()}] ` + msg;
      el.textContent += line + "\n";
      el.scrollTop = el.scrollHeight;
      dump.push(line);
      document.getElementById("download").href = "data:text/plain;charset=utf-8," + encodeURIComponent(dump.join("\n"));
    }

    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });

        log("ğŸ”Œ Verbinde mit " + device.name);
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');

        const characteristics = await service.getCharacteristics();
        for (const char of characteristics) {
          if (char.properties.notify) {
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', event => {
              const value = event.target.value;
              const hex = [...new Uint8Array(value.buffer)]
                .map(b => b.toString(16).padStart(2, '0')).join(' ');
              log(`â¬‡ï¸ [${char.uuid}]: ` + hex);
            });
            log(`âœ… Lausche auf: ${char.uuid}`);
          }
          if (char.properties.write || char.properties.writeWithoutResponse) {
            writeChar = char;
            log(`âœï¸ Write-Characteristic gefunden: ${char.uuid}`);
          }
        }
      } catch (error) {
        log("âŒ Fehler: " + error);
      }
    }

    async function sendHex() {
      if (!writeChar) {
        log("âš ï¸ Keine Write-Characteristic verfÃ¼gbar!");
        return;
      }
      const input = document.getElementById("hexInput").value.trim();
      if (!input) return;
      const bytes = input.split(" ").map(h => parseInt(h, 16));
      const buffer = new Uint8Array(bytes);
      try {
        await writeChar.writeValue(buffer);
        log("â¡ï¸ Gesendet: " + input.toUpperCase());
      } catch (err) {
        log("âŒ Senden fehlgeschlagen: " + err);
      }
    }
  </script>
</body>
</html>
